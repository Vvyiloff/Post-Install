name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.2)'
        required: true
        type: string

jobs:
  build-electron:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: electron/package-lock.json
      
      - name: Install dependencies
        run: |
          cd electron
          npm ci
      
      - name: Build Electron app
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: "false"
          WIN_CSC_LINK: ""
          WIN_CSC_KEY_PASSWORD: ""
        run: |
          cd electron
          $env:CSC_IDENTITY_AUTO_DISCOVERY = "false"
          $env:WIN_CSC_LINK = ""
          $env:WIN_CSC_KEY_PASSWORD = ""
          npm run build -- --win --x64 --publish never --config.win.sign=false --config.win.verifyUpdateCodeSignature=false --config.win.signDlls=false
      
      - name: Create Electron archive
        run: |
          cd electron/releases
          $version = (Get-Content ../package.json | ConvertFrom-Json).version
          Compress-Archive -Path "–£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –ø—Ä–æ–≥—Ä–∞–º–º-win32-x64" -DestinationPath "Post-Install-Electron-v$version.zip" -Force
          if (Test-Path "–£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –ø—Ä–æ–≥—Ä–∞–º–º $version Setup.exe") {
            Copy-Item "–£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –ø—Ä–æ–≥—Ä–∞–º–º $version Setup.exe" "Post-Install-Electron-v$version-Setup.exe"
          }
      
      - name: Upload Electron artifacts
        uses: actions/upload-artifact@v4
        with:
          name: electron-release
          path: |
            electron/releases/*.zip
            electron/releases/*.exe
          retention-days: 30
  
  build-python:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install PyInstaller
        run: |
          pip install pyinstaller
      
      - name: Build Python executable
        run: |
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "Listing all files in root:"
          Get-ChildItem -Path . -ErrorAction SilentlyContinue | Select-Object Name
          Write-Host "Checking for software_installer.py..."
          $pythonFile = $null
          if (Test-Path "python/software_installer.py") {
            Write-Host "File found in python/ directory!"
            $pythonFile = "python/software_installer.py"
            $workDir = "python"
          } elseif (Test-Path "software_installer.py") {
            Write-Host "File found in root directory!"
            $pythonFile = "software_installer.py"
            $workDir = "."
          } else {
            Write-Host "ERROR: software_installer.py not found"
            Write-Host "Files in root:"
            Get-ChildItem -Path . -ErrorAction SilentlyContinue | Select-Object Name
            Write-Host "Files in python/ (if exists):"
            Get-ChildItem -Path python -ErrorAction SilentlyContinue | Select-Object Name
            Write-Host "All .py files:"
            Get-ChildItem -Recurse -Filter "*.py" -ErrorAction SilentlyContinue | Select-Object FullName
            exit 1
          }
          Write-Host "Building from: $pythonFile"
          cd $workDir
          if ($workDir -eq ".") {
            New-Item -ItemType Directory -Force -Path "dist-python" | Out-Null
            pyinstaller --onefile --windowed --name "Post-Install-Python" --distpath dist-python software_installer.py
          } else {
            pyinstaller --onefile --windowed --name "Post-Install-Python" --distpath ../dist-python software_installer.py
          }
      
      - name: Get version from tag
        id: get_version
        run: |
          $version = "${{ github.ref_name }}".Replace("v", "")
          echo "version=$version" >> $env:GITHUB_OUTPUT
      
      - name: Create Python archive
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $filesToArchive = @()
          
          # Add the EXE if it exists
          if (Test-Path "dist-python/Post-Install-Python.exe") {
            $filesToArchive += "dist-python/Post-Install-Python.exe"
          } else {
            Write-Host "WARNING: dist-python/Post-Install-Python.exe not found ‚Äî skipping"
          }
          
          # Optional files (only add if present)
          foreach ($f in @("shared/packages.json", "README.md", "LICENSE")) {
            if (Test-Path $f) {
              $filesToArchive += $f
              Write-Host "Adding $f to archive"
            } else {
              Write-Host "WARNING: $f not found ‚Äî skipping"
            }
          }
          
          if ($filesToArchive.Count -gt 0) {
            Write-Host "Archiving files: $($filesToArchive -join ', ')"
            Compress-Archive -Path $filesToArchive -DestinationPath "Post-Install-Python-v$version.zip" -Force
            Write-Host "Archive created successfully: Post-Install-Python-v$version.zip"
          } else {
            Write-Host "ERROR: No files found to archive"
            exit 1
          }
      
      - name: Upload Python artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-release
          path: |
            Post-Install-Python-*.zip
            dist-python/*.exe
          retention-days: 30
  
  create-release:
    needs: [build-electron, build-python]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Electron artifacts
        uses: actions/download-artifact@v4
        with:
          name: electron-release
          path: ./artifacts/electron
      
      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-release
          path: ./artifacts/python
      
      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/electron/*
            artifacts/python/*
          name: Release v${{ steps.get_version.outputs.version }}
          body: |
            ## üéâ Release v${{ steps.get_version.outputs.version }}
            
            ### üì¶ –°–∫–∞—á–∞—Ç—å
            
            #### ‚ö° Electron –≤–µ—Ä—Å–∏—è (GUI)
            - **–£—Å—Ç–∞–Ω–æ–≤—â–∏–∫:** `Post-Install-Electron-v${{ steps.get_version.outputs.version }}-Setup.exe`
            - **–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è:** `Post-Install-Electron-v${{ steps.get_version.outputs.version }}.zip`
            
            #### üêç Python –≤–µ—Ä—Å–∏—è (Console)
            - **–ê—Ä—Ö–∏–≤:** `Post-Install-Python-v${{ steps.get_version.outputs.version }}.zip`
            
            ### üìã –ò–∑–º–µ–Ω–µ–Ω–∏—è
            –°–º. [Commits](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }})
            
            ---
            **–°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Post-Install!** ‚≠ê
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.2)'
        required: true
        type: string

jobs:
  build-electron:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: electron/package-lock.json
      
      - name: Install dependencies
        run: |
          cd electron
          npm ci
      
      - name: Build Electron app
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
        run: |
          cd electron
          npm run build
      
      - name: Create Electron archive
        run: |
          cd electron/releases
          $version = (Get-Content ../package.json | ConvertFrom-Json).version
          Compress-Archive -Path "–£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –ø—Ä–æ–≥—Ä–∞–º–º-win32-x64" -DestinationPath "Post-Install-Electron-v$version.zip" -Force
          if (Test-Path "–£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –ø—Ä–æ–≥—Ä–∞–º–º $version Setup.exe") {
            Copy-Item "–£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –ø—Ä–æ–≥—Ä–∞–º–º $version Setup.exe" "Post-Install-Electron-v$version-Setup.exe"
          }
      
      - name: Upload Electron artifacts
        uses: actions/upload-artifact@v4
        with:
          name: electron-release
          path: |
            electron/releases/*.zip
            electron/releases/*.exe
          retention-days: 30
  
  build-python:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install PyInstaller
        run: |
          pip install pyinstaller
      
      - name: Build Python executable
        run: |
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "Checking for python/software_installer.py..."
          if (Test-Path "python/software_installer.py") {
            Write-Host "File found! Building..."
            cd python
            pyinstaller --onefile --windowed --name "Post-Install-Python" --distpath ../dist-python software_installer.py
          } else {
            Write-Host "ERROR: software_installer.py not found in python/ directory"
            Write-Host "Files in python/:"
            Get-ChildItem -Path python -ErrorAction SilentlyContinue | Select-Object Name
            Write-Host "All .py files:"
            Get-ChildItem -Recurse -Filter "*.py" -ErrorAction SilentlyContinue | Select-Object FullName
            exit 1
          }
      
      - name: Get version from tag
        id: get_version
        run: |
          $version = "${{ github.ref_name }}".Replace("v", "")
          echo "version=$version" >> $env:GITHUB_OUTPUT
      
      - name: Create Python archive
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          if (Test-Path "dist-python/Post-Install-Python.exe") {
            Compress-Archive -Path "dist-python/Post-Install-Python.exe", "shared/packages.json", "README.md", "LICENSE" -DestinationPath "Post-Install-Python-v$version.zip" -Force
          }
      
      - name: Upload Python artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-release
          path: |
            Post-Install-Python-*.zip
            dist-python/*.exe
          retention-days: 30
  
  create-release:
    needs: [build-electron, build-python]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Electron artifacts
        uses: actions/download-artifact@v4
        with:
          name: electron-release
          path: ./artifacts/electron
      
      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-release
          path: ./artifacts/python
      
      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/electron/*
            artifacts/python/*
          name: Release v${{ steps.get_version.outputs.version }}
          body: |
            ## üéâ Release v${{ steps.get_version.outputs.version }}
            
            ### üì¶ –°–∫–∞—á–∞—Ç—å
            
            #### ‚ö° Electron –≤–µ—Ä—Å–∏—è (GUI)
            - **–£—Å—Ç–∞–Ω–æ–≤—â–∏–∫:** `Post-Install-Electron-v${{ steps.get_version.outputs.version }}-Setup.exe`
            - **–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è:** `Post-Install-Electron-v${{ steps.get_version.outputs.version }}.zip`
            
            #### üêç Python –≤–µ—Ä—Å–∏—è (Console)
            - **–ê—Ä—Ö–∏–≤:** `Post-Install-Python-v${{ steps.get_version.outputs.version }}.zip`
            
            ### üìã –ò–∑–º–µ–Ω–µ–Ω–∏—è
            –°–º. [Commits](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }})
            
            ---
            **–°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Post-Install!** ‚≠ê
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
